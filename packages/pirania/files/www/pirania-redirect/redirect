#!/usr/bin/lua

utils = require('voucher.utils')

local uci = require('uci')
local uci_cursor = uci.cursor()

function handle_request (env)
  local method = 'http://'
  local origin_url = utils.urlencode(method .. env.HTTP_HOST .. env.REQUEST_URI)
  local own_ipv4 = uci_cursor:get("network", "lan", "ipaddr")
  local auth_url = uci_cursor:get("pirania", "base_config", "url_auth")

  local redirect_url = method .. own_ipv4 .. auth_url .. "?prev=" .. origin_url

  uhttpd.send("Status: 302 \r\n")
  uhttpd.send("Location: " .. redirect_url .. "\r\n")
  uhttpd.send("\r\n") --! indicate uhttpd to send the response
end
